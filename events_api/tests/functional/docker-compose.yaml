version: "3.8"


x-env: &x-env
  env_file:
    - env_file


services:

  backend_api:
    restart: always
    container_name: backend_api
    build:
      args:
        POETRY_PARAMS: ""
      context: ../../
    volumes:
    - ../../:/app/
    image: backend_api
    command: python3 main.py
    ports:
      - "8000:8000"
    depends_on:
      - es
      - redis
    <<: *x-env

  tests:
    container_name: tests
    build:
      args:
        POETRY_PARAMS: ""
      context: ../../
    entrypoint: /app/tests/functional/entrypoint.sh
    volumes:
      - ../../../backend_api/:/app/
    depends_on:
      - es
      - redis
      - backend_api
    <<: *x-env


  es:
    restart: unless-stopped
    container_name: es
    image: library/elasticsearch:7.12.1
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1

  redis:
    restart: unless-stopped
    container_name: redis
    image: redis:6.2
    ports:
      - "6379:6379"
